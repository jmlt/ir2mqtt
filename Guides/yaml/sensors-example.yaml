# ===========================
# iR2mqtt LEGACY sensors
# ===========================
mqtt:
  sensor:
  
    # Speed sensor - car speed in m/s
    - name: "iR2mqtt Speed m/s"
      unique_id: ir2mqtt_speed_ms
      state_topic: "iracing/telemetry"
      value_template: "{{ value_json.speed | float | round(1) }}"
      unit_of_measurement: "m/s"
      device_class: "speed"
      icon: mdi:speedometer
      expire_after: 30
      
    # Speed sensor - car speed in km/h
    - name: "iR2mqtt Speed km/h"
      unique_id: ir2mqtt_speed_kmh
      state_topic: "iracing/telemetry"
      value_template: "{{ (value_json.speed | float * 3.6) | round(1) }}"
      unit_of_measurement: "km/h"
      device_class: "speed"
      icon: mdi:speedometer
      expire_after: 30
      
    # Speed sensor - car speed in mph
    - name: "iR2mqtt Speed mph"
      unique_id: ir2mqtt_speed_mph
      state_topic: "iracing/telemetry"
      value_template: "{{ (value_json.speed | float * 2.237) | round(1) }}"
      unit_of_measurement: "mph"
      device_class: "speed"
      icon: mdi:speedometer
      expire_after: 30

    # Engine RPM sensor
    - name: "iR2mqtt RPM"
      unique_id: ir2mqtt_rpm
      state_topic: "iracing/telemetry"
      value_template: "{{ value_json.rpm | int }}"
      unit_of_measurement: "RPM"
      icon: mdi:engine
      expire_after: 30

    # Current Gear sensor
    - name: "iR2mqtt Gear"
      unique_id: ir2mqtt_gear
      state_topic: "iracing/telemetry"
      value_template: "{{ value_json.gear }}"
      icon: mdi:car-shift-pattern
      expire_after: 30

    # Fuel Level sensor
    - name: "iR2mqtt Fuel Level"
      unique_id: ir2mqtt_fuel
      state_topic: "iracing/telemetry"
      value_template: "{{ value_json.fuel_level | float | round(2) }}"
      unit_of_measurement: "L"
      icon: mdi:gas-station
      expire_after: 30

    # Current Lap sensor
    - name: "iR2mqtt Lap"
      unique_id: ir2mqtt_lap
      state_topic: "iracing/telemetry"
      value_template: "{{ value_json.lap | int }}"
      unit_of_measurement: "lap"
      icon: mdi:flag-checkered
      expire_after: 30

    # Session Elapsed Time sensor (minutes)
    - name: "iR2mqtt Session Time"
      unique_id: ir2mqtt_session_time
      state_topic: "iracing/telemetry"
      value_template: "{{ (value_json.session_time | float / 60) | round(2) }}"
      unit_of_measurement: "min"
      device_class: "duration"
      icon: mdi:clock
      expire_after: 30

    # Session Remaining Time sensor (minutes)
    - name: "iR2mqtt Time Remaining"
      unique_id: ir2mqtt_time_remain
      state_topic: "iracing/telemetry"
      value_template: >
        {% if value_json.session_time_remain is defined %}
            {{ (value_json.session_time_remain | float / 60) | round(2) }}
        {% else %}
            {{ states('sensor.iracing_time_remain') | default(0) }}
        {% endif %}
      unit_of_measurement: "min"
      device_class: "duration"
      icon: mdi:clock-end
      expire_after: 30  

    # Session Type sensor
    - name: "iR2mqtt Session Type"
      unique_id: ir2mqtt_session_type
      state_topic: "iracing/telemetry"
      value_template: "{{ value_json.session_type }}"
      icon: mdi:trophy
      expire_after: 30

    # Session Name sensor
    - name: "iR2mqtt Session Name"
      unique_id: ir2mqtt_session_name
      state_topic: "iracing/telemetry"
      value_template: "{{ value_json.session_name }}"
      icon: mdi:format-title
      expire_after: 30

    # Active Flags sensor - main active flag or "No Flag"
    - name: "iR2mqtt Active Flag"
      unique_id: ir2mqtt_flags
      state_topic: "iracing/telemetry"
      value_template: >
        {{ value_json.active_flags[0] if value_json.active_flags else 'No Flag' }}
      icon: mdi:flag
      json_attributes_topic: "iracing/telemetry"
      json_attributes_template: >
        {
          "all_flags": {{ value_json.active_flags | tojson }},
          "session_flags": {{ value_json.session_flags }}
        }
      expire_after: 30

    # Telemetry Timestamp sensor
    - name: "iR2mqtt Timestamp"
      unique_id: ir2mqtt_timestamp
      state_topic: "iracing/telemetry"
      value_template: "{{ value_json.timestamp }}"
      icon: mdi:clock-digital
      expire_after: 30

    # Raw flags sensors (True/False for each flag)
    - name: "iR2mqtt Checkered Flag Raw"
      unique_id: ir2mqtt_flag_checkered_raw
      state_topic: "iracing/telemetry"
      value_template: "{{ 'Checkered' in value_json.active_flags }}"
      expire_after: 30

    - name: "iR2mqtt White Flag Raw"
      unique_id: ir2mqtt_flag_white_raw
      state_topic: "iracing/telemetry"
      value_template: "{{ 'White' in value_json.active_flags }}"
      expire_after: 30

    - name: "iR2mqtt Green Flag Raw"
      unique_id: ir2mqtt_flag_green_raw
      state_topic: "iracing/telemetry"
      value_template: "{{ 'Green' in value_json.active_flags }}"
      expire_after: 30

    - name: "iR2mqtt Yellow Flag Raw"
      unique_id: ir2mqtt_flag_yellow_raw
      state_topic: "iracing/telemetry"
      value_template: "{{ 'Yellow' in value_json.active_flags }}"
      expire_after: 30

    - name: "iR2mqtt Red Flag Raw"
      unique_id: ir2mqtt_flag_red_raw
      state_topic: "iracing/telemetry"
      value_template: "{{ 'Red' in value_json.active_flags }}"
      expire_after: 30

    - name: "iR2mqtt Blue Flag Raw"
      unique_id: ir2mqtt_flag_blue_raw
      state_topic: "iracing/telemetry"
      value_template: "{{ 'Blue' in value_json.active_flags }}"
      expire_after: 30

    - name: "iR2mqtt Debris Flag Raw"
      unique_id: ir2mqtt_flag_debris_raw
      state_topic: "iracing/telemetry"
      value_template: "{{ 'Debris' in value_json.active_flags }}"
      expire_after: 30

    - name: "iR2mqtt Crossed Flag Raw"
      unique_id: ir2mqtt_flag_crossed_raw
      state_topic: "iracing/telemetry"
      value_template: "{{ 'Crossed' in value_json.active_flags }}"
      expire_after: 30

    - name: "iR2mqtt Yellow Waving Flag Raw"
      unique_id: ir2mqtt_flag_yellow_waving_raw
      state_topic: "iracing/telemetry"
      value_template: "{{ 'Yellow Waving' in value_json.active_flags }}"
      expire_after: 30

    - name: "iR2mqtt Black Flag Raw"
      unique_id: ir2mqtt_flag_black_raw
      state_topic: "iracing/telemetry"
      value_template: "{{ 'Black' in value_json.active_flags }}"
      expire_after: 30

    - name: "iR2mqtt Repair Flag Raw"
      unique_id: ir2mqtt_flag_repair_raw
      state_topic: "iracing/telemetry"
      value_template: "{{ 'Repair' in value_json.active_flags }}"
      expire_after: 30

    - name: "iR2mqtt Caution Flag Raw"
      unique_id: ir2mqtt_flag_caution_raw
      state_topic: "iracing/telemetry"
      value_template: "{{ 'Caution' in value_json.active_flags }}"
      expire_after: 30

    - name: "iR2mqtt Caution Waving Flag Raw"
      unique_id: ir2mqtt_flag_caution_waving_raw
      state_topic: "iracing/telemetry"
      value_template: "{{ 'Caution Waving' in value_json.active_flags }}"
      expire_after: 30

    - name: "iR2mqtt Disqualify Flag Raw"
      unique_id: ir2mqtt_flag_disqualify_raw
      state_topic: "iracing/telemetry"
      value_template: "{{ 'Disqualify' in value_json.active_flags }}"
      expire_after: 30

    - name: "iR2mqtt Furled Flag Raw"
      unique_id: ir2mqtt_flag_furled_raw
      state_topic: "iracing/telemetry"
      value_template: "{{ 'Furled' in value_json.active_flags }}"
      expire_after: 30
      
    - name: "iR2mqtt Green Held Flag Raw"
      unique_id: ir2mqtt_flag_green_held_raw
      state_topic: "iracing/telemetry"
      value_template: "{{ 'Green Held' in value_json.active_flags }}"
      expire_after: 30

    - name: "iR2mqtt Random Waving Flag Raw"
      unique_id: ir2mqtt_flag_random_waving_raw
      state_topic: "iracing/telemetry"
      value_template: "{{ 'Random Waving' in value_json.active_flags }}"
      expire_after: 30
      
    - name: "iR2mqtt On Pit Road Raw"
      unique_id: ir2mqtt_on_pit_road_raw
      state_topic: "iracing/telemetry"
      value_template: "{{ value_json.on_pit_road }}"
      expire_after: 30

    # Incidents sensor
    - name: "iR2mqtt Incidents"
      unique_id: ir2mqtt_incs
      state_topic: "iracing/telemetry"
      value_template: "{{ value_json.incs }}"
      icon: mdi:alert
      expire_after: 30
  
    # Start Lights sensor
    - name: "iR2mqtt Start Lights"
      unique_id: ir2mqtt_startlights
      state_topic: "iracing/telemetry"
      value_template: >
        {{ value_json.active_lights[0] if value_json.active_lights else 'No Lights' }}
      icon: mdi:traffic-light
      json_attributes_topic: "iracing/telemetry"
      json_attributes_template: >
        {
          "all_lights": {{ value_json.active_lights | tojson }},
        }
      expire_after: 30
    
    # Start Lights Sensor raw
    - name: "iR2mqtt Ready Raw"
      unique_id: ir2mqtt_ready_light
      state_topic: "iracing/telemetry"
      value_template: "{{ 'Ready' in value_json.active_lights }}"
      icon: mdi:traffic-light
      expire_after: 30
      
    - name: "iR2mqtt Set Raw"
      unique_id: ir2mqtt_set_light
      state_topic: "iracing/telemetry"
      value_template: "{{ 'Set' in value_json.active_lights }}"
      icon: mdi:traffic-light
      expire_after: 30
      
    - name: "iR2mqtt Go Raw"
      unique_id: ir2mqtt_go_light
      state_topic: "iracing/telemetry"
      value_template: "{{ 'Go' in value_json.active_lights }}"
      icon: mdi:traffic-light
      expire_after: 30

binary_sensor:
  - platform: template
    sensors:
      ir2mqtt_checkered_flag:
        friendly_name: "iR2MQTT Checkered Flag"
        unique_id: ir2mqtt_checkered_flag_bs
        value_template: "{{ is_state('sensor.ir2mqtt_checkered_flag_raw', 'True') }}"
        icon_template: mdi:flag-checkered

      ir2mqtt_white_flag:
        friendly_name: "iR2MQTT White Flag"
        unique_id: ir2mqtt_white_flag_bs
        value_template: "{{ is_state('sensor.ir2mqtt_white_flag_raw', 'True') }}"
        icon_template: mdi:flag-outline

      ir2mqtt_green_flag:
        friendly_name: "iR2MQTT Green Flag"
        unique_id: ir2mqtt_green_flag_bs
        value_template: "{{ is_state('sensor.ir2mqtt_green_flag_raw', 'True') }}"
        icon_template: mdi:flag-variant

      ir2mqtt_yellow_flag:
        friendly_name: "iR2MQTT Yellow Flag"
        unique_id: ir2mqtt_yellow_flag_bs
        value_template: "{{ is_state('sensor.ir2mqtt_yellow_flag_raw', 'True') }}"
        icon_template: mdi:flag

      ir2mqtt_red_flag:
        friendly_name: "iR2MQTT Red Flag"
        unique_id: ir2mqtt_red_flag_bs
        value_template: "{{ is_state('sensor.ir2mqtt_red_flag_raw', 'True') }}"
        icon_template: mdi:flag

      ir2mqtt_blue_flag:
        friendly_name: "iR2MQTT Blue Flag"
        unique_id: ir2mqtt_blue_flag_bs
        value_template: "{{ is_state('sensor.ir2mqtt_blue_flag_raw', 'True') }}"
        icon_template: mdi:flag

      ir2mqtt_debris_flag:
        friendly_name: "iR2MQTT Debris Flag"
        unique_id: ir2mqtt_debris_flag_bs
        value_template: "{{ is_state('sensor.ir2mqtt_debris_flag_raw', 'True') }}"
        icon_template: mdi:flag

      ir2mqtt_crossed_flag:
        friendly_name: "iR2MQTT Crossed Flag"
        unique_id: ir2mqtt_crossed_flag_bs
        value_template: "{{ is_state('sensor.ir2mqtt_crossed_flag_raw', 'True') }}"
        icon_template: mdi:flag

      ir2mqtt_yellow_waving_flag:
        friendly_name: "iR2MQTT Yellow Waving Flag"
        unique_id: ir2mqtt_yellow_wave_flag_bs
        value_template: "{{ is_state('sensor.ir2mqtt_yellow_waving_flag_raw', 'True') }}"
        icon_template: mdi:flag

      ir2mqtt_black_flag:
        friendly_name: "iR2MQTT Black Flag"
        unique_id: ir2mqtt_black_flag_bs
        value_template: "{{ is_state('sensor.ir2mqtt_black_flag_raw', 'True') }}"
        icon_template: mdi:flag

      ir2mqtt_repair_flag:
        friendly_name: "iR2MQTT Repair Flag"
        unique_id: ir2mqtt_repair_flag_bs
        value_template: "{{ is_state('sensor.ir2mqtt_repair_flag_raw', 'True') }}"
        icon_template: mdi:flag

      ir2mqtt_caution_flag:
        friendly_name: "iR2MQTT Caution Flag"
        unique_id: ir2mqtt_caution_flag_bs
        value_template: "{{ is_state('sensor.ir2mqtt_caution_flag_raw', 'True') }}"
        icon_template: mdi:flag

      ir2mqtt_caution_waving_flag:
        friendly_name: "iR2MQTT Caution Waving Flag"
        unique_id: ir2mqtt_caution_wave_flag_bs
        value_template: "{{ is_state('sensor.ir2mqtt_caution_waving_flag_raw', 'True') }}"
        icon_template: mdi:flag

      ir2mqtt_disqualify_flag:
        friendly_name: "iR2MQTT Disqualify Flag"
        unique_id: ir2mqtt_disqualify_flag_bs
        value_template: "{{ is_state('sensor.ir2mqtt_flag_disqualify_raw', 'True') }}"
        icon_template: mdi:flag

      ir2mqtt_furled_flag:
        friendly_name: "iR2MQTT Furled Flag"
        unique_id: ir2mqtt_furled_flag_bs
        value_template: "{{ is_state('sensor.ir2mqtt_flag_furled_raw', 'True') }}"
        icon_template: mdi:flag

      ir2mqtt_green_held_flag:
        friendly_name: "iR2MQTT Green Held Flag"
        unique_id: ir2mqtt_greenheld_flag_bs
        value_template: "{{ is_state('sensor.ir2mqtt_flag_green_held_raw', 'True') }}"
        icon_template: mdi:flag

      ir2mqtt_random_waving_flag:
        friendly_name: "iR2MQTT Random Waving Flag"
        unique_id: ir2mqtt_randomwaving_flag_bs
        value_template: "{{ is_state('sensor.ir2mqtt_flag_random_waving_raw', 'True') }}"
        icon_template: mdi:flag
    
      ir2mqtt_on_pit_road:
        friendly_name: "iR2MQTT On Pit Road"
        unique_id: ir2mqtt_pitroad_bs
        value_template: "{{ is_state('sensor.ir2mqtt_on_pit_road_raw', 'True') }}"
        icon_template: mdi:gauge

      ir2mqtt_ready_light:
        friendly_name: "iR2MQTT Ready Light"
        unique_id: ir2mqtt_ready_light_bs
        value_template: "{{ is_state('sensor.ir2mqtt_ready_raw', 'True') }}"
        icon_template: mdi:traffic-light

      ir2mqtt_set_light:
        friendly_name: "iR2MQTT Set Light"
        unique_id: ir2mqtt_set_light_bs
        value_template: "{{ is_state('sensor.ir2mqtt_set_raw', 'True') }}"
        icon_template: mdi:traffic-light

      ir2mqtt_go_light:
        friendly_name: "iR2MQTT Go Light"
        unique_id: ir2mqtt_go_light_bs
        value_template: "{{ is_state('sensor.ir2mqtt_go_raw', 'True') }}"
        icon_template: mdi:traffic-light
# ===========================
# End of iR2mqtt sensors
# ===========================
